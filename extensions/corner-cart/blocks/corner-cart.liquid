<script>
  window.__SHOP_MONEY_FORMAT__ = "{{ shop.money_format | escape }}";
</script>

{% comment %} <script>
document.addEventListener("DOMContentLoaded", function() {

  console.log("üü¶ Testing CSS extraction using FAKE JSON‚Ä¶");

  // FAKE CAMPAIGN DATA (edit this for testing)
  const fakeCampaignData = {
    campaigns: [
      {
        id: "test_campaign_1",
        status: "active",
        campaignType: "tiered",
        trackType: "quantity",
        goals: [
          {
            id: "g1",
            type: "free_shipping",
            target: 1,
            giftTitleBefore: ".optimaio-progress-fill {background:red !important; }"
          },
          {
            id: "g2",
            type: "order_discount",
            target: 2,
            giftTitleBefore: ".optimaio-milestone-label { color: green !important; }"
          }
        ]
      }
    ]
  };

  /* ---------------------------
     CSS INJECTION LOGIC
  ----------------------------*/
  function injectCSS(cssString) {
    let style = document.getElementById("optimaio-test-css");
    
    if (!style) {
      style = document.createElement("style");
      style.id = "optimaio-test-css";
      document.head.appendChild(style);
    }

    // Ensure CSS has !important where needed
    cssString = cssString
      .replace(/;(?![^{}]*})/g, " !important;")  
      .trim();

    style.textContent = cssString;
  }

  function testCSSFromFakeJSON(data) {
    const active = data.campaigns?.find(c => c.status === "active");
    if (!active) return console.warn("‚ö† No active campaign in fake JSON");

    let cssFound = [];

    active.goals.forEach(goal => {
      const css = goal.giftTitleBefore;

      if (typeof css === "string" && css.includes("{") && css.includes("}")) {
        cssFound.push(css);
      }
    });

    if (!cssFound.length) {
      console.warn("‚ö† No CSS found in fake JSON");
      return;
    }

    console.log("üé® CSS found:", cssFound);

    injectCSS(cssFound.join("\n"));

    console.log("üéâ Fake JSON CSS applied successfully!");
  }

  // Run test
  testCSSFromFakeJSON(fakeCampaignData);

});
</script> {% endcomment %}

<script>
/* ----------------------------------------------------
   üåê GLOBAL OPTIMAIO CAMPAIGN ENGINE
   - Supports CACHE or FRESH mode
   - Still guarantees: ONLY ONE fetch at a time
---------------------------------------------------- */

window.__OPTIMIAO_FETCH_STATE__ = {
  data: null,        // saved campaign data
  pending: null,     // shared promise
  lastFetch: 0,      // timestamp
  TTL: 0             // üëà CACHE TIME IN MS (0 = ALWAYS FRESH)
};

/* ====================================================
   CONFIGURE CACHE TIME HERE
   TTL = 0       ‚Üí No cache (always fresh)
   TTL = 5000    ‚Üí Cache for 5 seconds
   TTL = 60000   ‚Üí Cache for 1 minute
   TTL = 120000  ‚Üí Cache for 2 minutes
==================================================== */
window.__OPTIMIAO_FETCH_STATE__.TTL = 60000;  // ‚Üê CHANGE THIS


/* ----------------------------------------------------
   MAIN FETCH FUNCTION (fresh request)
---------------------------------------------------- */
async function fetchCampaignFresh() {
  const state = window.__OPTIMIAO_FETCH_STATE__;
  const start = performance.now();

  if (state.pending) return state.pending;

  state.pending = fetch("/apps/optimaio-cart/activeCampaigns", {
    cache: "no-store"
  })
    .then(res => res.json())
    .then(json => {
      state.data = json;
      state.lastFetch = Date.now();

      console.log(
        `%c‚ö° Optimaio Main Fetch (fresh): ${Math.round(performance.now() - start)}ms`,
        "color:#4caf50",
        json
      );

      state.pending = null;
      return json;
    })
    .catch(err => {
      console.warn("‚ö†Ô∏è Optimaio Fetch Failed", err);
      state.pending = null;
      throw err;
    });

  return state.pending;
}


/* ----------------------------------------------------
   PUBLIC FUNCTION USED BY ALL SCRIPTS
   (Reads Cache OR Fetches Fresh)
---------------------------------------------------- */
window.getCampaignData = async function() {
  const state = window.__OPTIMIAO_FETCH_STATE__;
  const now = Date.now();

  // ‚úî 1) If we have cached data + TTL not expired ‚Üí return cache
  if (state.TTL > 0 && state.data && now - state.lastFetch < state.TTL) {
    console.log("%cüì¶ Optimaio Campaign (cached)", "color:#2196f3", state.data);
    return state.data;
  }

  // ‚úî 2) Otherwise ‚Üí fetch fresh
  return fetchCampaignFresh();
};


/* ----------------------------------------------------
   OPTIONAL AUTO REFRESH TIMER
   (Good if TTL is large)
---------------------------------------------------- */
const AUTO_REFRESH_TIMER = 0; // 0 = off

if (AUTO_REFRESH_TIMER > 0) {
  setInterval(() => {
    console.log("%cüîÑ Auto-refreshing campaign (timer)", "color: orange");
    fetchCampaignFresh();
  }, AUTO_REFRESH_TIMER);
}
</script>
 

{% comment %} <script>
/* ----------------------------------------------------
   üåê GLOBAL OPTIMAIO CAMPAIGN ENGINE (1 fetch only)
   Fresh data + Shared across all scripts
---------------------------------------------------- */

window.__OPTIMIAO_FETCH_STATE__ = {
  data: null,       // latest campaign data
  pending: null,    // shared promise
  lastFetch: 0,     // timestamp
  refreshGap: 0     // 0 = always fresh, no caching
};

/* ----------------------------------------------------
   MAIN FETCH FUNCTION (always fresh)
---------------------------------------------------- */
async function fetchCampaignFresh() {
  const state = window.__OPTIMIAO_FETCH_STATE__;
  const start = performance.now();

  // If fetch already in progress ‚Üí WAIT for same promise
  if (state.pending) return state.pending;

  // Start new fetch
  state.pending = fetch("/apps/optimaio-cart/activeCampaigns", {
    cache: "no-store"
  })
    .then(res => res.json())
    .then(json => {
      state.data = json;
      state.lastFetch = Date.now();

      console.log(
        `%c‚ö° Optimaio Main Fetch (fresh): ${Math.round(performance.now() - start)}ms`,
        "color:#4caf50",
        json
      );

      state.pending = null;
      return json;
    })
    .catch(err => {
      console.warn("‚ö†Ô∏è Optimaio Fetch Failed", err);
      state.pending = null;
      throw err;
    });

  return state.pending;
}

/* ----------------------------------------------------
   PUBLIC function used by ALL Scripts
---------------------------------------------------- */
window.getCampaignData = async function() {
  const state = window.__OPTIMIAO_FETCH_STATE__;
  const now = Date.now();

  // No cache at all ‚Üí ALWAYS fetch fresh
  return fetchCampaignFresh();
};

/* ----------------------------------------------------
   OPTIONAL: AUTO REFRESH TIMER (TURN ON IF YOU WANT)
---------------------------------------------------- */
// ‚ùó Set to 0 to disable | Example: 60_000 = refresh every 60 seconds
const AUTO_REFRESH_TIMER = 0;

if (AUTO_REFRESH_TIMER > 0) {
  setInterval(() => {
    console.log("%cüîÑ Auto-refreshing campaign (timer)", "color: orange");
    fetchCampaignFresh();
  }, AUTO_REFRESH_TIMER);
}

</script> {% endcomment %}


<script>
  window.__OPTIMAIO_CURRENCIES__ = {{ shop.metafields.optimaio_cart.currencies.value | json }};
  window.__SHOP_MONEY_FORMAT__ = "{{ shop.money_format | escape }}";

 {% comment %} // Store only latest fetch time + last data
  window.__OptimaioCampaignCache = {
    data: null,
    fetchTime: 0  // milliseconds
  };

  window.fetchOptimaioCampaign = async function() {
    console.log("%c[Optimaio] üîÑ Fetching fresh campaign‚Ä¶", "color:#007bff");

    // ‚è± Start timer
    const startTime = performance.now();

    try {
      const res = await fetch("/apps/optimaio-cart/activeCampaigns", { cache: "no-store" });

      // HTTP error handling
      if (!res.ok) {
        console.error("[Optimaio] ‚ùå HTTP Error:", res.status);
        return null;
      }

      const data = await res.json();

      // ‚è± End timer
      const endTime = performance.now();
      window.__OptimaioCampaignCache.fetchTime = Math.round(endTime - startTime);

      console.log(
        `%c[Optimaio] ‚úÖ Fresh campaign received in liquid ${window.__OptimaioCampaignCache.fetchTime}ms`,
        "color:#4caf50"
      );

      window.__OptimaioCampaignCache.data = data;

      return data;

    } catch (err) {
      const endTime = performance.now();
      window.__OptimaioCampaignCache.fetchTime = Math.round(endTime - startTime);

      console.error(
        `%c[Optimaio] üö® Fetch failed after ${window.__OptimaioCampaignCache.fetchTime}ms`,
        "color:red"
      );

      return null;
    }
  }; {% endcomment %}
</script>


 
 {% assign style = 'darkgdg' %}

{{ 'optimaio-core.css' | asset_url | stylesheet_tag }}

{% case style %}
  {% when 'cool' %}
    {{ 'optimaio-theme-cool.css' | asset_url | stylesheet_tag }}
    {% when 'dark' %}
    {{ 'optimaio-theme-dark.css' | asset_url | stylesheet_tag }}
  {% else %}
    {{ 'optimaio-theme-minimal.css' | asset_url | stylesheet_tag }}
{% endcase %}

 
<!-- Optimaio Universal Responsive Cart Drawer -->
<div id="optimaio-corner-cart">
  üõí <span id="optimaio-corner-cart-count">0</span>
</div>
 
<div id="optimaio-cart-drawer" class="optimaio-cart-drawer" data-active-tab="cart">
  
  <!-- Header -->
  <div class="optimaio-cart-drawer__header">
    <h2 class="optimaio-cart-tile">My Cart</h2>
    <button type="button" class="optimaio-cart-drawer__close">√ó</button>
  </div>

  <div id="optimaio-countdown" class="optimaio-countdown">
  <span class="optimaio-countdown-label">‚è≥ Offer ends in</span>
  <span id="optimaio-countdown-time">
    <span class="optimaio-time"><strong>00</strong>d</span>
    <span class="optimaio-time"><strong>00</strong>h</span>
    <span class="optimaio-time"><strong>00</strong>m</span>
    <span class="optimaio-time"><strong>00</strong>s</span>
  </span>
</div>
{% render 'optimaio-progress-bar' %}
 
  <!-- Middle Scrollable Body -->
  <div class="optimaio-cart-drawer__middle">
    
 
    <!-- TAB: CART -->
    <div class="optimaio-cart-tab optimaio-cart-tab--cart" data-tab="cart">
      

      {% comment %} <!-- üîí Hidden template used by BXGY to render the instant gift card -->
<template id="optimaio-free-gift-template">
  <div class="optimaio-cart-item-card optimaio-free-gift">
    <div class="optimaio-cart-item__image">
      <img src="" alt="Free gift" />
    </div>
    <div class="optimaio-cart-item__info">
      <div class="optimaio-cart-item__top">
        <p class="optimaio-cart-item__title"></p>
        <span class="optimaio-free-gift-status">Adding‚Ä¶</span>
      </div>
      <div class="optimaio-cart-item__bottom">
        <div class="optimaio-cart-item__actions">
          <span class="optimaio-cart-item__qty">1</span>
        </div>
        <div class="optimaio-cart-item__pricing">
          <span class="optimaio-price">‚Äî</span>
        </div>
      </div>
      <div class="optimaio-cart-item__discount"><span>Free Gift Pending</span></div>
    </div>
  </div>
</template> {% endcomment %}

      <div class="optimaio-cart-drawer__items"></div>
 
      <div class="optimaio-cart-drawer__empty" style="display:none;">
        <p>Your cart is empty</p>
        <a href="/" class="optimaio-continue-btn">Continue Shopping</a>
      </div>
 
      <div class="optimaio-cart-drawer__recommendations">
        <h3>You might also like</h3>
        <div class="optimaio-recommendations-list"></div>
      </div>
    </div>
 
    <!-- TAB: OFFERS -->
    <div class="optimaio-cart-tab optimaio-cart-tab--offers" data-tab="offers">
      {% render 'optimaio-offers' %}
    </div>
  </div>
 
  <!-- Footer Summary -->
  <div class="optimaio-cart-drawer__summary-checkout">
    <div class="optimaio-cart-drawer__summary">
      <div class="optimaio-discount-row">
        <span class="optimaio-discount-label">Discount:</span>
        <span class="optimaio-discount-amount">‚Çπ0</span>
      </div>
      <div class="optimaio-total-row">
        <span class="optimaio-total-label">Total:</span>
        <span class="optimaio-total-amount">‚Çπ0</span>
      </div>
    </div>
    <button onclick="window.location='/checkout'" class="optimaio-checkout-btn">Proceed to Checkout</button>
  </div>
 
  <!-- Footer Tabs -->
  <div class="optimaio-cart-drawer__footer">
    <button class="optimaio-tab-btn active" data-target="cart">üõí Cart</button>
    <button class="optimaio-tab-btn" data-target="offers">üéÅ Offers</button>
  </div>
</div>
 

<script>
(function () {
  const container = document.getElementById("optimaio-countdown");
  if (!container) return;

  const boxes = container.querySelectorAll(".optimaio-time strong");
  if (boxes.length !== 4) return;

  // üîí STATIC END DATE: 31 DEC (local time)
  const endTime = new Date(
    new Date().getFullYear(),
    11, // December
    31,
    23, 59, 59
  ).getTime();

  function updateCountdown() {
    let diff = endTime - Date.now();

    if (diff <= 0) {
      container.style.display = "none";
      return;
    }

    const days = Math.floor(diff / 86400000);
    diff -= days * 86400000;

    const hours = Math.floor(diff / 3600000);
    diff -= hours * 3600000;

    const minutes = Math.floor(diff / 60000);
    diff -= minutes * 60000;

    const seconds = Math.floor(diff / 1000);

    boxes[0].textContent = String(days).padStart(2, "0");
    boxes[1].textContent = String(hours).padStart(2, "0");
    boxes[2].textContent = String(minutes).padStart(2, "0");
    boxes[3].textContent = String(seconds).padStart(2, "0");
  }

  updateCountdown();
  setInterval(updateCountdown, 1000);
})();
</script>


<script src="{{ 'optimaio-gift.js' | asset_url }}" defer></script> 

<script src="{{ 'optimaio.js' | asset_url }}" defer></script>
{% comment %} <script src="{{ 'free-gift.js' | asset_url }}" defer></script> 
<script src="{{ 'bxgy.js' | asset_url }}" defer></script>  {% endcomment %}


 
{% comment %} <style>
 
/* ‚úÖ All styles prefixed with optimaio- */
.optimaio-cart-item__discount {
  font-size: 12px;
  color: #a33;
  margin-top: 4px;
  background: #fdeaea;
  padding: 4px 6px;
  border-radius: 4px;
  display: inline-block;
}
 
.optimaio-cart-item-card{display:flex;gap:12px;background:#fff;border:1px solid #eee;border-radius:10px;padding:12px;position:relative;}
.optimaio-cart-item__image img{width:70px;height:70px;border-radius:8px;object-fit:cover;}
.optimaio-cart-item__info{flex:1;display:flex;flex-direction:column;justify-content:space-between;}
.optimaio-cart-item__top{display:flex;justify-content:space-between;align-items:flex-start;gap:8px;}
.optimaio-cart-item__title{font-weight:600;margin:0;line-height:1.4;flex:1;white-space:normal;word-break:break-word;}
.optimaio-cart-item__remove{flex-shrink:0;background:none;border:none;font-size:16px;cursor:pointer;color:#888;line-height:1;}
.optimaio-cart-item__remove:hover{color:#d33;}
.optimaio-cart-item__variant{font-size:12px;color:#666;margin:2px 0 6px;}
.optimaio-cart-item__bottom{display:flex;justify-content:space-between;align-items:center;margin-top:auto;}
.optimaio-cart-item__pricing{display:flex;gap:6px;align-items:baseline;}
.optimaio-compare-at{text-decoration:line-through;color:#999;font-size:12px;}
.optimaio-price{font-weight:700;color:#222;}
.optimaio-cart-tab{display:none;}
.optimaio-cart-drawer[data-active-tab="cart"] .optimaio-cart-tab--cart{display:block;}
.optimaio-cart-drawer[data-active-tab="offers"] .optimaio-cart-tab--offers{display:block;}
.optimaio-cart-drawer[data-active-tab="offers"] .optimaio-cart-drawer__summary-checkout{display:none;}
.optimaio-qty-btn.loading,.optimaio-cart-item__remove.loading,.optimaio-rec-add.loading{position:relative;color:transparent!important;pointer-events:none;}
.optimaio-qty-btn.loading::after,.optimaio-cart-item__remove.loading::after,.optimaio-rec-add.loading::after{content:"";position:absolute;top:50%;left:50%;width:12px;height:12px;border:2px solid #999;border-top-color:transparent;border-radius:50%;transform:translate(-50%,-50%);animation:optimaio-spin .6s linear infinite;}
@keyframes optimaio-spin{to{transform:translate(-50%,-50%) rotate(360deg);}}
#optimaio-corner-cart,.optimaio-cart-drawer{font-family:Inter,sans-serif;box-sizing:border-box;}
#optimaio-corner-cart{position:fixed;bottom:20px;right:20px;background:#000;color:#fff;padding:10px 16px;border-radius:40px;cursor:pointer;font-size:14px;z-index:9999;box-shadow:0 4px 12px rgba(0,0,0,0.2);}
#optimaio-corner-cart span{font-weight:700;margin:0 4px;}
.optimaio-cart-drawer{position:fixed;top:0;right:0;width:90%;max-width:420px;height:100%;background:#fff7f8;transform:translateX(100%);transition:transform .3s ease;box-shadow:-3px 0 12px rgba(0,0,0,0.25);z-index:10000;display:flex;flex-direction:column;}
.optimaio-cart-drawer.open{transform:translateX(0);}
.optimaio-cart-drawer__header{flex-shrink:0;display:flex;justify-content:space-between;align-items:center;padding:14px 18px;border-bottom:1px solid #eee;background:#fff;position:sticky;top:0;z-index:5;}
.optimaio-cart-drawer__header h2{font-size:18px;margin:0;font-weight:600;}
.optimaio-cart-drawer__close{font-size:20px;background:none;border:none;cursor:pointer;}
.optimaio-cart-drawer__middle{flex:1;overflow-y:auto;padding:12px 16px;}
.optimaio-cart-drawer__middle::-webkit-scrollbar{width:6px;}
.optimaio-cart-drawer__middle::-webkit-scrollbar-thumb{background:#ccc;border-radius:4px;}
.optimaio-cart-drawer__alert{background:#fdeaea;color:#a33;padding:8px;border-radius:8px;text-align:center;font-size:13px;margin-bottom:8px;}
.optimaio-cart-drawer__progress{display:flex;justify-content:space-between;font-size:11px;margin-bottom:10px;}
.optimaio-cart-drawer__progress .optimaio-step{flex:1;text-align:center;border-bottom:2px solid #ccc;padding-bottom:3px;}
.optimaio-cart-drawer__progress .done{border-color:#d48b8b;font-weight:600;}
.optimaio-cart-drawer__items{display:flex;flex-direction:column;gap:10px;}
.optimaio-cart-drawer__empty{display:flex;flex-direction:column;align-items:center;justify-content:center;min-height:50vh;color:#666;text-align:center;gap:12px;}
.optimaio-continue-btn{background:#000;color:#fff;padding:10px 20px;border-radius:25px;font-size:14px;text-decoration:none;}
.optimaio-recommendations-list{display:flex;overflow-x:auto;gap:10px;padding-bottom:8px;}
.optimaio-recommendation-card{flex:0 0 75%;background:#fff;border:1px solid #eee;border-radius:8px;padding:8px;display:flex;align-items:center;gap:10px;}
.optimaio-rec-image img{width:60px;height:60px;border-radius:6px;object-fit:cover;}
.optimaio-rec-title{font-size:12px;font-weight:600;margin:0;}
.optimaio-rec-price{font-size:12px;font-weight:500;color:#222;margin:2px 0;}
.optimaio-rec-add{background:#000;color:#fff;border:none;padding:6px 10px;border-radius:4px;cursor:pointer;font-size:12px;}
.optimaio-cart-drawer__summary-checkout{flex-shrink:0;border-top:1px solid #eee;padding:12px 14px;background:#fff;}
.optimaio-discount-row,.optimaio-total-row{display:flex;justify-content:space-between;font-size:14px;}
.optimaio-discount-label,.optimaio-discount-amount{color:#a33;}
.optimaio-total-label{font-weight:600;}
.optimaio-total-amount{font-weight:700;}
.optimaio-checkout-btn{margin-top:8px;width:100%;background:#000;color:#fff;padding:10px;border:none;border-radius:6px;font-weight:600;cursor:pointer;}
.optimaio-cart-drawer__footer{flex-shrink:0;display:flex;justify-content:space-around;border-top:1px solid #eee;background:#fff;padding:12px;position:sticky;bottom:0;}
.optimaio-cart-drawer__footer button{border:none;background:none;cursor:pointer;font-size:14px;font-weight:500;color:#444;}
.optimaio-cart-drawer__footer button.active{color:#d48b8b;font-weight:600;}
@media (max-width:768px){#optimaio-corner-cart{bottom:15px;right:15px;font-size:13px;padding:8px 14px;}}
</style> {% endcomment %}
 

{% schema %}
{
"name": "Optimaio Corner Cart",
"target": "body",
"settings": []
}
{% endschema %}